# BM25 æ£€ç´¢å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

BM25 æ£€ç´¢å™¨å·²æˆåŠŸå®ç°ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… **ä¸­æ–‡åˆ†è¯**ï¼šä½¿ç”¨ jieba è¿›è¡Œæ™ºèƒ½ä¸­æ–‡åˆ†è¯
- âœ… **BM25 ç®—æ³•**ï¼šåŸºäºè¯é¢‘çš„ç¨€ç–æ£€ç´¢ï¼Œå¯¹ä¸“ä¸šæœ¯è¯­å‘½ä¸­ç‡é«˜
- âœ… **æŒä¹…åŒ–å­˜å‚¨**ï¼šä½¿ç”¨ pickle æ ¼å¼ä¿å­˜ç´¢å¼•
- âœ… **æ··åˆæ£€ç´¢**ï¼šæ”¯æŒä¸å‘é‡æ£€ç´¢ç»“åˆä½¿ç”¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å•ç‹¬ä½¿ç”¨ BM25 æ£€ç´¢

```python
from rag_engine import add_to_bm25_index, search_bm25, get_bm25_stats

# æ·»åŠ æ–‡æ¡£åˆ° BM25 ç´¢å¼•
documents = [
    "ABSD æ˜¯ä¸€ç§èµ„äº§æ”¯æŒè¯åˆ¸åŒ–äº§å“",
    "BM25 ç®—æ³•å¯¹ä¸“ä¸šæœ¯è¯­å‘½ä¸­ç‡é«˜",
    "å‘é‡æ£€ç´¢é€‚åˆè¯­ä¹‰ç†è§£"
]
add_to_bm25_index(documents)

# æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡
stats = get_bm25_stats()
print(f"ç´¢å¼•ç»Ÿè®¡: {stats}")

# æ£€ç´¢
results = search_bm25("ABSD æ˜¯ä»€ä¹ˆ", k=3)
for text, score in results:
    print(f"[{score:.4f}] {text}")
```

### 2. ä½¿ç”¨æ··åˆæ£€ç´¢ï¼ˆæ¨èï¼‰

```python
from rag_engine import hybrid_search, add_to_vector_db, add_to_bm25_index, embed_texts

# å‡†å¤‡æ–‡æ¡£
documents = [
    "ABSD æ˜¯ä¸€ç§èµ„äº§æ”¯æŒè¯åˆ¸åŒ–äº§å“",
    "å‘é‡æ£€ç´¢é€šè¿‡è¯­ä¹‰ç›¸ä¼¼åº¦è¿›è¡ŒåŒ¹é…"
]

# åŒæ—¶æ·»åŠ åˆ°ä¸¤ä¸ªç´¢å¼•
embeddings = embed_texts(documents)
add_to_vector_db(documents, embeddings)
add_to_bm25_index(documents)

# æ··åˆæ£€ç´¢
results = hybrid_search(
    query="ABSD äº§å“",
    k=3,
    vector_weight=0.5  # å‘é‡å’Œ BM25 å„å  50%
)

for text, score in results:
    print(f"[{score:.4f}] {text}")
```

---

## ğŸ¯ æ ¸å¿ƒ API

### `add_to_bm25_index(chunks: List[str])`
å°†æ–‡æ¡£æ·»åŠ åˆ° BM25 ç´¢å¼•ã€‚

**å‚æ•°ï¼š**
- `chunks`: æ–‡æœ¬ç‰‡æ®µåˆ—è¡¨

**ç¤ºä¾‹ï¼š**
```python
add_to_bm25_index(["æ–‡æ¡£1", "æ–‡æ¡£2", "æ–‡æ¡£3"])
```

---

### `search_bm25(query: str, k: int = 3)`
ä½¿ç”¨ BM25 æ£€ç´¢æœ€ç›¸å…³çš„æ–‡æ¡£ã€‚

**å‚æ•°ï¼š**
- `query`: æŸ¥è¯¢æ–‡æœ¬
- `k`: è¿”å›çš„ç»“æœæ•°é‡

**è¿”å›ï¼š**
- `List[Tuple[str, float]]`: [(æ–‡æ¡£, BM25åˆ†æ•°), ...]

**ç¤ºä¾‹ï¼š**
```python
results = search_bm25("ABSD æ˜¯ä»€ä¹ˆ", k=5)
```

---

### `hybrid_search(query: str, k: int = 3, vector_weight: float = 0.5)`
æ··åˆæ£€ç´¢ï¼šç»“åˆå‘é‡æ£€ç´¢å’Œ BM25ã€‚

**å‚æ•°ï¼š**
- `query`: æŸ¥è¯¢æ–‡æœ¬
- `k`: è¿”å›çš„ç»“æœæ•°é‡
- `vector_weight`: å‘é‡æ£€ç´¢çš„æƒé‡ï¼ˆ0-1ï¼‰ï¼ŒBM25 æƒé‡ä¸º 1-vector_weight

**è¿”å›ï¼š**
- `List[Tuple[str, float]]`: [(æ–‡æ¡£, ç»¼åˆåˆ†æ•°), ...]

**ç¤ºä¾‹ï¼š**
```python
# å‘é‡æ£€ç´¢æƒé‡ 70%ï¼ŒBM25 æƒé‡ 30%
results = hybrid_search("ABSD äº§å“", k=3, vector_weight=0.7)
```

---

### `clear_bm25_index()`
æ¸…ç©º BM25 ç´¢å¼•ã€‚

**ç¤ºä¾‹ï¼š**
```python
clear_bm25_index()
```

---

### `get_bm25_stats()`
è·å– BM25 ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ã€‚

**è¿”å›ï¼š**
- `dict`: {"total_chunks": æ•°é‡, "total_tokens": è¯æ•°}

**ç¤ºä¾‹ï¼š**
```python
stats = get_bm25_stats()
print(f"å·²ç´¢å¼• {stats['total_chunks']} ä¸ªæ–‡æ¡£")
```

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šä¸“ä¸šæœ¯è¯­æŸ¥è¯¢
**é—®é¢˜ï¼š** å‘é‡æ£€ç´¢å¯¹ "ABSD"ã€"CDO" ç­‰ä¸“ä¸šæœ¯è¯­ç†è§£ä¸å‡†ç¡®

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ BM25 æˆ–æ··åˆæ£€ç´¢
```python
# BM25 å¯¹ç²¾ç¡®åŒ¹é…æ•ˆæœå¥½
results = search_bm25("ABSD äº§å“ä»‹ç»", k=5)
```

---

### åœºæ™¯ 2ï¼šè¯­ä¹‰ç†è§£ + ç²¾ç¡®åŒ¹é…
**é—®é¢˜ï¼š** æ—¢éœ€è¦è¯­ä¹‰ç†è§£ï¼Œåˆéœ€è¦ç²¾ç¡®åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨æ··åˆæ£€ç´¢
```python
# å¹³è¡¡è¯­ä¹‰å’Œç²¾ç¡®åŒ¹é…
results = hybrid_search("èµ„äº§è¯åˆ¸åŒ–äº§å“", k=5, vector_weight=0.5)
```

---

### åœºæ™¯ 3ï¼šè°ƒæ•´æ£€ç´¢ç­–ç•¥
**é—®é¢˜ï¼š** ä¸åŒæŸ¥è¯¢éœ€è¦ä¸åŒçš„æ£€ç´¢ç­–ç•¥

**è§£å†³æ–¹æ¡ˆï¼š** åŠ¨æ€è°ƒæ•´æƒé‡
```python
# ä¸“ä¸šæœ¯è¯­æŸ¥è¯¢ï¼šBM25 æƒé‡æ›´é«˜
results = hybrid_search("ABSD", k=5, vector_weight=0.3)

# è¯­ä¹‰æŸ¥è¯¢ï¼šå‘é‡æƒé‡æ›´é«˜
results = hybrid_search("å¦‚ä½•ç†è§£èµ„äº§è¯åˆ¸åŒ–", k=5, vector_weight=0.7)
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. ç›´æ¥ä½¿ç”¨ BM25Retriever ç±»

```python
from rag.retriever import BM25Retriever

# åˆ›å»ºæ£€ç´¢å™¨
retriever = BM25Retriever("custom_index.pkl")

# æ·»åŠ æ–‡æ¡£
retriever.add_documents(["æ–‡æ¡£1", "æ–‡æ¡£2"])

# æ£€ç´¢
documents = retriever.retrieve_by_text("æŸ¥è¯¢", top_k=5)

for doc in documents:
    print(f"ID: {doc.id}")
    print(f"æ–‡æœ¬: {doc.text}")
    print(f"åˆ†æ•°: {doc.metadata['bm25_score']}")
```

---

### 2. è‡ªå®šä¹‰åˆ†è¯

```python
from rag.retriever import BM25Retriever
import jieba

# æ·»åŠ è‡ªå®šä¹‰è¯å…¸
jieba.load_userdict("custom_dict.txt")

# ä½¿ç”¨ BM25Retrieverï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ jiebaï¼‰
retriever = BM25Retriever("index.pkl")
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ£€ç´¢æ–¹å¼ | ä¸“ä¸šæœ¯è¯­ | è¯­ä¹‰ç†è§£ | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|------|---------|
| **å‘é‡æ£€ç´¢** | â­â­ | â­â­â­â­â­ | æ…¢ | è¯­ä¹‰æŸ¥è¯¢ã€æ„å›¾ç†è§£ |
| **BM25** | â­â­â­â­â­ | â­â­ | å¿« | ç²¾ç¡®åŒ¹é…ã€ä¸“ä¸šæœ¯è¯­ |
| **æ··åˆæ£€ç´¢** | â­â­â­â­ | â­â­â­â­ | ä¸­ | ç»¼åˆåœºæ™¯ï¼ˆæ¨èï¼‰ |

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: BM25 ç´¢å¼•æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ
**A:** é»˜è®¤ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `bm25_index.pkl`

### Q2: å¦‚ä½•åŒæ­¥å‘é‡åº“å’Œ BM25 ç´¢å¼•ï¼Ÿ
**A:** ä¸Šä¼ æ–‡ä»¶æ—¶éœ€è¦åŒæ—¶è°ƒç”¨ä¸¤ä¸ªå‡½æ•°ï¼š
```python
# åœ¨ app.py ä¸­
embeddings = embed_texts(chunks)
add_to_vector_db(chunks, embeddings)
add_to_bm25_index(chunks)  # æ–°å¢è¿™ä¸€è¡Œ
```

### Q3: æ··åˆæ£€ç´¢çš„æƒé‡å¦‚ä½•é€‰æ‹©ï¼Ÿ
**A:** å»ºè®®ï¼š
- é€šç”¨æŸ¥è¯¢ï¼š`vector_weight=0.5`ï¼ˆé»˜è®¤ï¼‰
- ä¸“ä¸šæœ¯è¯­å¤šï¼š`vector_weight=0.3`
- è¯­ä¹‰ç†è§£ä¸ºä¸»ï¼š`vector_weight=0.7`

### Q4: BM25 æ”¯æŒè‹±æ–‡å—ï¼Ÿ
**A:** æ”¯æŒï¼Œjieba ä¼šè‡ªåŠ¨å¤„ç†è‹±æ–‡åˆ†è¯ã€‚

---

## ğŸ‰ æµ‹è¯•ç»“æœ

```bash
# æµ‹è¯•å‘½ä»¤
python3 -c "
from rag_engine import add_to_bm25_index, search_bm25

docs = ['ABSD æ˜¯ä¸€ç§èµ„äº§æ”¯æŒè¯åˆ¸åŒ–äº§å“']
add_to_bm25_index(docs)
results = search_bm25('ABSD æ˜¯ä»€ä¹ˆ', k=1)
print(results)
"

# è¾“å‡º
[('ABSD æ˜¯ä¸€ç§èµ„äº§æ”¯æŒè¯åˆ¸åŒ–äº§å“', 1.6668)]
âœ… BM25 æ£€ç´¢æµ‹è¯•é€šè¿‡ï¼
```

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **åœ¨ UI ä¸­é›†æˆ**ï¼šä¿®æ”¹ `app.py`ï¼Œæ·»åŠ  BM25 å’Œæ··åˆæ£€ç´¢é€‰é¡¹
2. **è‡ªåŠ¨åŒæ­¥**ï¼šä¸Šä¼ æ–‡ä»¶æ—¶è‡ªåŠ¨æ·»åŠ åˆ° BM25 ç´¢å¼•
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹å¤§è§„æ¨¡æ•°æ®è¿›è¡Œç´¢å¼•ä¼˜åŒ–
4. **æ•ˆæœè¯„ä¼°**ï¼šå¯¹æ¯”ä¸åŒæ£€ç´¢ç­–ç•¥çš„å‡†ç¡®ç‡

---

**å®ç°å®Œæˆæ—¶é—´ï¼š** 2024-12-25  
**çŠ¶æ€ï¼š** âœ… å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡
