# æ•°æ®åŒæ­¥é—®é¢˜è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡ï¼š** å¯¼å…¥é¢„å¤„ç†æ•°æ®åï¼ŒUI æ˜¾ç¤ºå‘é‡åº“å’Œ BM25 ç´¢å¼•éƒ½æœ‰ 1292 ä¸ªæ–‡æ¡£ï¼Œä½† BM25 æ£€ç´¢ä¸åˆ°ç»“æœï¼Œéœ€è¦æ‰‹åŠ¨è¿è¡ŒåŒæ­¥è„šæœ¬æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ” é—®é¢˜æ ¹æº

### æ—¶é—´çº¿

1. **ä½ å¯¼å…¥æ•°æ®æ—¶**ï¼ˆBM25 åŠŸèƒ½å®ç°ä¹‹å‰ï¼‰
   ```python
   # æ—§ç‰ˆæœ¬çš„å¯¼å…¥ä»£ç ï¼ˆæ²¡æœ‰ BM25ï¼‰
   embeddings = embed_texts(batch)
   add_to_vector_db(batch, embeddings)
   # âŒ æ²¡æœ‰ add_to_bm25_index(batch)
   ```
   
   **ç»“æœï¼š**
   - âœ… å‘é‡åº“ï¼š1292 ä¸ªæ–‡æ¡£
   - âŒ BM25 ç´¢å¼•ï¼š0 ä¸ªæ–‡æ¡£

2. **æˆ‘å®ç° BM25 åŠŸèƒ½å**ï¼ˆæ˜¨å¤©ï¼‰
   ```python
   # æ–°ç‰ˆæœ¬çš„å¯¼å…¥ä»£ç ï¼ˆæœ‰ BM25ï¼‰
   embeddings = embed_texts(batch)
   add_to_vector_db(batch, embeddings)
   add_to_bm25_index(batch)  # âœ… æ–°å¢
   ```
   
   **ä½†é—®é¢˜æ˜¯ï¼š**
   - ä½ çš„æ•°æ®å·²ç»å¯¼å…¥å®Œæˆäº†
   - æ–°ä»£ç åªå¯¹**æ–°å¯¼å…¥çš„æ•°æ®**ç”Ÿæ•ˆ
   - **æ—§æ•°æ®ä¸ä¼šè‡ªåŠ¨åŒæ­¥**

3. **UI æ˜¾ç¤ºé—®é¢˜**
   - UI æ˜¾ç¤º BM25 ç´¢å¼• 1292 ä¸ª â† ä¸ºä»€ä¹ˆï¼Ÿ
   - å› ä¸º BM25 ç´¢å¼•æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ•°æ®
   - ä½†æ•°æ®æ˜¯åæ¥æ‰‹åŠ¨åŒæ­¥çš„

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

### æ ¸å¿ƒåŸå› ï¼š**æ•°æ®å¯¼å…¥æ—¶æœºé—®é¢˜**

```
æ—¶é—´è½´ï¼š
  
T1: ä½ å¯¼å…¥æ•°æ®ï¼ˆ1292 ä¸ªæ–‡æ¡£ï¼‰
    â””â”€> åªæœ‰å‘é‡æ£€ç´¢åŠŸèƒ½
    â””â”€> å‘é‡åº“ âœ… | BM25 ç´¢å¼• âŒ

T2: æˆ‘å®ç° BM25 åŠŸèƒ½
    â””â”€> ä¿®æ”¹ä»£ç æ·»åŠ  BM25 åŒæ­¥
    â””â”€> ä½†ä¸å½±å“å·²å¯¼å…¥çš„æ•°æ®

T3: ä½ æµ‹è¯• BM25 æ£€ç´¢
    â””â”€> BM25 ç´¢å¼•ä¸ºç©º â†’ æ£€ç´¢å¤±è´¥ âŒ

T4: æ‰‹åŠ¨è¿è¡ŒåŒæ­¥è„šæœ¬
    â””â”€> ä»å‘é‡åº“å¤åˆ¶æ•°æ®åˆ° BM25
    â””â”€> å‘é‡åº“ âœ… | BM25 ç´¢å¼• âœ…
```

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥ï¼ˆæ¨èï¼‰âœ…

åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹æ•°æ®ä¸ä¸€è‡´ï¼Œå¹¶æç¤ºåŒæ­¥ã€‚

**å®ç°ï¼š**

```python
# åœ¨ app.py å¯åŠ¨æ—¶æ£€æŸ¥
def check_index_sync():
    """æ£€æŸ¥å‘é‡åº“å’Œ BM25 ç´¢å¼•æ˜¯å¦åŒæ­¥"""
    vector_stats = get_db_stats()
    bm25_stats = get_bm25_stats()
    
    if vector_stats['total_chunks'] != bm25_stats['total_chunks']:
        return False, vector_stats['total_chunks'], bm25_stats['total_chunks']
    return True, 0, 0

# åœ¨ä¾§è¾¹æ æ˜¾ç¤ºè­¦å‘Š
is_synced, v_count, b_count = check_index_sync()
if not is_synced:
    st.warning(f"âš ï¸ ç´¢å¼•ä¸åŒæ­¥ï¼å‘é‡åº“: {v_count}, BM25: {b_count}")
    if st.button("ğŸ”„ ç«‹å³åŒæ­¥"):
        sync_bm25_from_vector_db()
        st.success("âœ… åŒæ­¥å®Œæˆï¼")
        st.rerun()
```

---

### æ–¹æ¡ˆ2ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥

åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥ï¼ˆå¯èƒ½å½±å“å¯åŠ¨é€Ÿåº¦ï¼‰ã€‚

```python
# åœ¨ app.py çš„ main() å‡½æ•°å¼€å§‹å¤„
if not check_index_sync()[0]:
    with st.spinner("æ­£åœ¨åŒæ­¥ BM25 ç´¢å¼•..."):
        sync_bm25_from_vector_db()
```

---

### æ–¹æ¡ˆ3ï¼šæ·»åŠ åŒæ­¥æŒ‰é’®

åœ¨ UI ä¸­æ·»åŠ æ‰‹åŠ¨åŒæ­¥æŒ‰é’®ã€‚

```python
# åœ¨ä¾§è¾¹æ æ·»åŠ 
if st.button("ğŸ”„ åŒæ­¥ BM25 ç´¢å¼•"):
    with st.spinner("æ­£åœ¨åŒæ­¥..."):
        sync_bm25_from_vector_db()
    st.success("âœ… åŒæ­¥å®Œæˆï¼")
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### æ¨èå®ç°ï¼šæ™ºèƒ½æ£€æµ‹ + ä¸€é”®åŒæ­¥

```python
def init_session_state():
    """åˆå§‹åŒ– session state"""
    if 'initialized' not in st.session_state:
        st.session_state.initialized = False
    if 'sync_checked' not in st.session_state:
        st.session_state.sync_checked = False

def check_and_prompt_sync():
    """æ£€æŸ¥å¹¶æç¤ºåŒæ­¥"""
    if st.session_state.sync_checked:
        return
    
    vector_stats = get_db_stats()
    bm25_stats = get_bm25_stats()
    
    if vector_stats['total_chunks'] != bm25_stats['total_chunks']:
        st.sidebar.error(f"""
        âš ï¸ **ç´¢å¼•ä¸åŒæ­¥**
        
        - å‘é‡åº“: {vector_stats['total_chunks']} ä¸ªæ–‡æ¡£
        - BM25 ç´¢å¼•: {bm25_stats['total_chunks']} ä¸ªæ–‡æ¡£
        
        è¿™å¯èƒ½å¯¼è‡´ BM25 æ£€ç´¢ç»“æœä¸å‡†ç¡®ã€‚
        """)
        
        if st.sidebar.button("ğŸ”„ ç«‹å³åŒæ­¥ BM25 ç´¢å¼•", type="primary"):
            with st.spinner("æ­£åœ¨åŒæ­¥..."):
                sync_bm25_from_vector_db()
            st.success("âœ… åŒæ­¥å®Œæˆï¼")
            st.rerun()
    else:
        st.session_state.sync_checked = True
```

---

## ğŸ“ ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨åŒæ­¥ï¼Ÿ

### è€ƒè™‘å› ç´ 

1. **æ€§èƒ½å½±å“**
   - 1292 ä¸ªæ–‡æ¡£åŒæ­¥éœ€è¦ 10-20 ç§’
   - æ¯æ¬¡å¯åŠ¨éƒ½åŒæ­¥ä¼šå½±å“ç”¨æˆ·ä½“éªŒ

2. **æ•°æ®å®‰å…¨**
   - è‡ªåŠ¨åŒæ­¥å¯èƒ½è¦†ç›–ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹çš„æ•°æ®
   - éœ€è¦ç”¨æˆ·ç¡®è®¤

3. **é€æ˜æ€§**
   - è®©ç”¨æˆ·çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
   - ç”¨æˆ·å¯ä»¥é€‰æ‹©åŒæ­¥æ—¶æœº

---

## ğŸš€ å®æ–½è®¡åˆ’

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å®æ–½ï¼‰

åœ¨ä¾§è¾¹æ æ·»åŠ åŒæ­¥æ£€æµ‹å’Œä¸€é”®åŒæ­¥æŒ‰é’®ï¼š

```python
# åœ¨ä¾§è¾¹æ çš„å‘é‡åº“çŠ¶æ€éƒ¨åˆ†
st.subheader("ğŸ“Š å‘é‡åº“çŠ¶æ€")
stats = get_db_stats()
bm25_stats = get_bm25_stats()

col1, col2 = st.columns(2)
with col1:
    st.metric("å‘é‡åº“", stats["total_chunks"])
with col2:
    st.metric("BM25 ç´¢å¼•", bm25_stats["total_chunks"])

# æ£€æŸ¥åŒæ­¥çŠ¶æ€
if stats["total_chunks"] != bm25_stats["total_chunks"]:
    st.warning(f"âš ï¸ ç´¢å¼•ä¸åŒæ­¥ï¼ˆå·®å¼‚: {abs(stats['total_chunks'] - bm25_stats['total_chunks'])} ä¸ªæ–‡æ¡£ï¼‰")
    if st.button("ğŸ”„ åŒæ­¥ BM25 ç´¢å¼•", use_container_width=True):
        with st.spinner("æ­£åœ¨åŒæ­¥..."):
            sync_bm25_from_vector_db()
        st.success("âœ… åŒæ­¥å®Œæˆï¼")
        st.rerun()
else:
    st.success("âœ… ç´¢å¼•å·²åŒæ­¥")
```

---

### é•¿æœŸæ–¹æ¡ˆï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

1. **å¢é‡åŒæ­¥**
   - åªåŒæ­¥æ–°å¢çš„æ–‡æ¡£
   - ç»´æŠ¤åŒæ­¥çŠ¶æ€è®°å½•

2. **åå°åŒæ­¥**
   - ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡
   - ä¸é˜»å¡ UI

3. **ç‰ˆæœ¬æ§åˆ¶**
   - è®°å½•ç´¢å¼•ç‰ˆæœ¬
   - è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬ä¸ä¸€è‡´

---

## ğŸ“ æ€»ç»“

### é—®é¢˜æœ¬è´¨

**æ•°æ®å¯¼å…¥æ—¶æœº â‰  åŠŸèƒ½å®ç°æ—¶æœº**

- ä½ çš„æ•°æ®å¯¼å…¥åœ¨ BM25 åŠŸèƒ½å®ç°ä¹‹å‰
- æ—§ä»£ç ä¸ä¼šè‡ªåŠ¨æ›´æ–°å·²å¯¼å…¥çš„æ•°æ®
- éœ€è¦æ‰‹åŠ¨åŒæ­¥æˆ–è‡ªåŠ¨æ£€æµ‹åŒæ­¥

### è§£å†³æ–¹æ¡ˆ

1. âœ… **æ·»åŠ åŒæ­¥æ£€æµ‹**ï¼ˆæ¨èï¼‰
2. âœ… **æä¾›ä¸€é”®åŒæ­¥æŒ‰é’®**
3. âš ï¸ è‡ªåŠ¨åŒæ­¥ï¼ˆå¯é€‰ï¼Œå½±å“æ€§èƒ½ï¼‰

### æœ€ä½³å®è·µ

**åœ¨ UI ä¸­æ·»åŠ æ™ºèƒ½æ£€æµ‹ï¼š**
- å¯åŠ¨æ—¶æ£€æŸ¥ç´¢å¼•æ˜¯å¦åŒæ­¥
- ä¸åŒæ­¥æ—¶æ˜¾ç¤ºè­¦å‘Šå’ŒåŒæ­¥æŒ‰é’®
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ‰‹åŠ¨åŒæ­¥
- åŒæ­¥å®Œæˆåæ ‡è®°ä¸ºå·²æ£€æŸ¥

---

**è¿™æ ·æ—¢ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼Œåˆä¸å½±å“ç”¨æˆ·ä½“éªŒï¼**
