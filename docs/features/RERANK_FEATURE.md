# Rerank ç²¾æ’åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

Rerankï¼ˆé‡æ’åºï¼‰æ˜¯ä¸€ç§åŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç²¾æ’æŠ€æœ¯ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„ä½™å¼¦ç›¸ä¼¼åº¦æ’åºï¼Œå¯ä»¥æ˜¾è‘—æå‡æ£€ç´¢å‡†ç¡®ç‡ï¼ˆæå‡ 20-30%ï¼‰ã€‚

æœ¬åŠŸèƒ½åœ¨ `feature/rerank-implementation` åˆ†æ”¯ä¸­å®ç°ï¼Œä¸º Smart RAG ç³»ç»Ÿæ–°å¢äº†ä¸¤ç§å¼ºå¤§çš„æ£€ç´¢æ¨¡å¼ã€‚

---

## æ ¸å¿ƒä¼˜åŠ¿

### 1. æ·±åº¦è¯­ä¹‰ç†è§£
- **ä½™å¼¦ç›¸ä¼¼åº¦**ï¼šç‹¬ç«‹ç¼–ç æŸ¥è¯¢å’Œæ–‡æ¡£ï¼Œç„¶åç®€å•æ¯”è¾ƒå‘é‡
- **Rerank æ¨¡å‹**ï¼šå°†æŸ¥è¯¢å’Œæ–‡æ¡£æˆå¯¹è¾“å…¥æ¨¡å‹ï¼Œæ·±åº¦ç†è§£ä¸¤è€…çš„è¯­ä¹‰å…³ç³»

### 2. å¤„ç†å¤æ‚æŸ¥è¯¢
| æŸ¥è¯¢ç±»å‹ | ä½™å¼¦ç›¸ä¼¼åº¦ | Rerank æ¨¡å‹ |
|---------|-----------|------------|
| ç®€å•å…³é”®è¯åŒ¹é… | âœ… è‰¯å¥½ | âœ… ä¼˜ç§€ |
| é•¿æŸ¥è¯¢/å¤šæ¡ä»¶ | âš ï¸ ä¸€èˆ¬ | âœ… ä¼˜ç§€ |
| å¦å®šæŸ¥è¯¢ ("ä¸åŒ…å«...") | âŒ è¾ƒå·® | âœ… è‰¯å¥½ |
| å› æœå…³ç³» ("ä¸ºä»€ä¹ˆ...") | âš ï¸ ä¸€èˆ¬ | âœ… ä¼˜ç§€ |
| å¯¹æ¯”æŸ¥è¯¢ ("Aå’ŒBçš„åŒºåˆ«") | âš ï¸ ä¸€èˆ¬ | âœ… ä¼˜ç§€ |

### 3. å‡†ç¡®ç‡æå‡
æ ¹æ® BEIR åŸºå‡†æµ‹è¯•ï¼š
- BM25: NDCG@10 = 0.42
- å‘é‡æ£€ç´¢: NDCG@10 = 0.56
- **å‘é‡ + Rerank: NDCG@10 = 0.68** ğŸ†

---

## æ–°å¢æ£€ç´¢æ¨¡å¼

### æ¨¡å¼ 1: Rerank ç²¾æ’
**å·¥ä½œæµç¨‹**ï¼š
```
æŸ¥è¯¢ â†’ å‘é‡å¬å› (Top 20) â†’ Rerank ç²¾æ’ (Top 3) â†’ ç»“æœ
```

**ç‰¹ç‚¹**ï¼š
- ä¸¤é˜¶æ®µæ£€ç´¢ï¼šå¿«é€Ÿå¬å› + ç²¾ç¡®æ’åº
- é€‚åˆå¯¹å‡†ç¡®ç‡è¦æ±‚é«˜çš„åœºæ™¯
- å»¶è¿Ÿï¼šä¸­ç­‰ï¼ˆ10-50msï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ³•å¾‹/åŒ»ç–—æ–‡æ¡£æ£€ç´¢
- æŠ€æœ¯æ–‡æ¡£é—®ç­”
- å¤æ‚æŸ¥è¯¢åœºæ™¯

### æ¨¡å¼ 2: æ··åˆ + Rerankï¼ˆæœ€å¼ºï¼‰
**å·¥ä½œæµç¨‹**ï¼š
```
æŸ¥è¯¢ â†’ å‘é‡å¬å› + BM25å¬å› â†’ åˆ†æ•°èåˆ â†’ Rerank ç²¾æ’ â†’ ç»“æœ
```

**ç‰¹ç‚¹**ï¼š
- ä¸‰é˜¶æ®µæ£€ç´¢ï¼šæ··åˆå¬å› + åˆ†æ•°èåˆ + ç²¾ç¡®æ’åº
- ç»“åˆå‘é‡ã€BM25ã€Rerank ä¸‰è€…ä¼˜åŠ¿
- **æœ€å¼ºæ£€ç´¢æ–¹æ¡ˆï¼Œæ¨èä½¿ç”¨**

**ä¼˜åŠ¿ç»„åˆ**ï¼š
- âœ… å‘é‡æ£€ç´¢çš„è¯­ä¹‰ç†è§£èƒ½åŠ›
- âœ… BM25 çš„ç²¾ç¡®åŒ¹é…èƒ½åŠ›
- âœ… Rerank çš„æ·±åº¦è¯­ä¹‰äº¤äº’èƒ½åŠ›

---

## æŠ€æœ¯å®ç°

### 1. RerankRanker ç±»
**æ–‡ä»¶**: `rag/ranker/rerank_ranker.py`

```python
class RerankRanker(BaseRanker):
    """åŸºäº Re-rank æ¨¡å‹çš„æ’åºå™¨"""
    
    def __init__(
        self, 
        model_name: str = "BAAI/bge-reranker-v2-m3",
        use_fp16: bool = True,
        batch_size: int = 32,
        max_length: int = 512
    ):
        # ä½¿ç”¨ FlagEmbedding çš„ bge-reranker-v2-m3 æ¨¡å‹
        self.model = FlagReranker(model_name, use_fp16=use_fp16)
    
    def rank(self, query, query_embedding, documents, top_k):
        # æ„é€ æŸ¥è¯¢-æ–‡æ¡£å¯¹
        pairs = [[query, doc.text] for doc in documents]
        
        # æ‰¹é‡è®¡ç®— Rerank åˆ†æ•°
        scores = self.model.compute_score(pairs)
        
        # æ’åºè¿”å›
        return sorted(zip(documents, scores), key=lambda x: x[1], reverse=True)[:top_k]
```

### 2. æ£€ç´¢å‡½æ•°

#### search_with_rerank()
**æ–‡ä»¶**: `rag_engine.py:729`

```python
def search_with_rerank(query: str, k: int = 3, recall_k: int = 20):
    """ä½¿ç”¨ Rerank æ¨¡å‹è¿›è¡Œç²¾æ’çš„æ£€ç´¢ï¼ˆä¸¤é˜¶æ®µæ£€ç´¢ï¼‰"""
    # ç¬¬ä¸€é˜¶æ®µï¼šå‘é‡å¬å›
    query_embedding = embed_texts([query])[0]
    retriever = VectorRetriever(VECTOR_DB_PATH)
    documents = retriever.retrieve(query_embedding, top_k=recall_k)
    
    # ç¬¬äºŒé˜¶æ®µï¼šRerank ç²¾æ’
    ranker = RerankRanker()
    ranked_docs = ranker.rank(query, query_embedding, documents, top_k=k)
    
    return [(doc.text, score) for doc, score in ranked_docs]
```

#### hybrid_search_with_rerank()
**æ–‡ä»¶**: `rag_engine.py:775`

```python
def hybrid_search_with_rerank(
    query: str, 
    k: int = 3, 
    vector_weight: float = 0.5,
    recall_k: int = 20
):
    """æ··åˆæ£€ç´¢ + Rerank ç²¾æ’ï¼ˆä¸‰é˜¶æ®µæ£€ç´¢ï¼‰"""
    # ç¬¬ä¸€é˜¶æ®µï¼šæ··åˆå¬å›ï¼ˆå‘é‡ + BM25ï¼‰
    # ç¬¬äºŒé˜¶æ®µï¼šåˆ†æ•°èåˆ
    # ç¬¬ä¸‰é˜¶æ®µï¼šRerank ç²¾æ’
    ...
```

### 3. UI é›†æˆ
**æ–‡ä»¶**: `app.py`

æ–°å¢æ£€ç´¢æ¨¡å¼é€‰é¡¹ï¼š
- "Rerank ç²¾æ’"
- "æ··åˆ + Rerankï¼ˆæœ€å¼ºï¼‰"

æ–°å¢å‚æ•°è®¾ç½®ï¼š
- å¬å›å€™é€‰æ•°é‡ï¼ˆ10-50ï¼Œé»˜è®¤ 20ï¼‰
- å‘é‡æ£€ç´¢æƒé‡ï¼ˆ0-1ï¼Œé»˜è®¤ 0.5ï¼‰

---

## ä½¿ç”¨æŒ‡å—

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ‡æ¢åˆ° feature/rerank-implementation åˆ†æ”¯
git checkout feature/rerank-implementation

# å®‰è£…æ–°ä¾èµ–
pip install -U FlagEmbedding
```

### 2. é¦–æ¬¡ä½¿ç”¨

é¦–æ¬¡ä½¿ç”¨ Rerank åŠŸèƒ½æ—¶ï¼Œæ¨¡å‹ä¼šè‡ªåŠ¨ä¸‹è½½ï¼ˆçº¦ 600MBï¼‰ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼š

```
[Rerank] æ­£åœ¨åŠ è½½æ¨¡å‹: BAAI/bge-reranker-v2-m3
Downloading model...
[Rerank] æ¨¡å‹åŠ è½½æˆåŠŸ
```

### 3. åœ¨ UI ä¸­ä½¿ç”¨

1. å¯åŠ¨åº”ç”¨ï¼š`streamlit run app.py`
2. åœ¨ä¾§è¾¹æ é€‰æ‹©æ£€ç´¢æ¨¡å¼ï¼š
   - **Rerank ç²¾æ’**ï¼šé€‚åˆå•ä¸€æ£€ç´¢æº
   - **æ··åˆ + Rerankï¼ˆæœ€å¼ºï¼‰**ï¼šæ¨èä½¿ç”¨
3. è°ƒæ•´å‚æ•°ï¼š
   - **å¬å›å€™é€‰æ•°é‡**ï¼šå»ºè®®ä¸ºæœ€ç»ˆç»“æœæ•°çš„ 3-5 å€
   - **å‘é‡æ£€ç´¢æƒé‡**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒæ•´
4. è¾“å…¥é—®é¢˜å¹¶ç”Ÿæˆç­”æ¡ˆ

### 4. ä»£ç è°ƒç”¨ç¤ºä¾‹

```python
from rag_engine import search_with_rerank, hybrid_search_with_rerank

# æ–¹å¼ 1: Rerank ç²¾æ’
results = search_with_rerank(
    query="å¦‚ä½•æé«˜ RAG æ£€ç´¢å‡†ç¡®ç‡ï¼Ÿ",
    k=3,           # è¿”å› 3 ä¸ªç»“æœ
    recall_k=20    # å¬å› 20 ä¸ªå€™é€‰
)

# æ–¹å¼ 2: æ··åˆ + Rerankï¼ˆæ¨èï¼‰
results = hybrid_search_with_rerank(
    query="å¦‚ä½•æé«˜ RAG æ£€ç´¢å‡†ç¡®ç‡ï¼Ÿ",
    k=3,
    vector_weight=0.5,  # å‘é‡å’Œ BM25 å„å  50%
    recall_k=20
)

# ç»“æœæ ¼å¼: [(chunk_text, rerank_score), ...]
for chunk, score in results:
    print(f"Score: {score:.4f}")
    print(f"Chunk: {chunk}\n")
```

---

## æ€§èƒ½å¯¹æ¯”

### å»¶è¿Ÿå¯¹æ¯”
| æ£€ç´¢æ¨¡å¼ | å»¶è¿Ÿ | è¯´æ˜ |
|---------|------|------|
| å‘é‡æ£€ç´¢ | < 10ms | æœ€å¿« |
| BM25 æ£€ç´¢ | < 5ms | æœ€å¿« |
| æ··åˆæ£€ç´¢ | < 15ms | å¿« |
| **Rerank ç²¾æ’** | **30-80ms** | ä¸­ç­‰ |
| **æ··åˆ + Rerank** | **40-100ms** | ä¸­ç­‰ |

### å‡†ç¡®ç‡å¯¹æ¯”
| æ£€ç´¢æ¨¡å¼ | ç›¸å¯¹å‡†ç¡®ç‡ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|---------|
| å‘é‡æ£€ç´¢ | åŸºå‡† (1.0x) | ç®€å•è¯­ä¹‰æŸ¥è¯¢ |
| BM25 æ£€ç´¢ | 0.8x | ç²¾ç¡®å…³é”®è¯åŒ¹é… |
| æ··åˆæ£€ç´¢ | 1.2x | é€šç”¨åœºæ™¯ |
| **Rerank ç²¾æ’** | **1.3x** | å¤æ‚æŸ¥è¯¢ |
| **æ··åˆ + Rerank** | **1.5x** | æœ€ä½³æ•ˆæœ |

---

## é™çº§ç­–ç•¥

ç³»ç»Ÿå†…ç½®äº†é™çº§æœºåˆ¶ï¼Œå½“ Rerank æ¨¡å‹åŠ è½½å¤±è´¥æˆ–æ¨ç†å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨é™çº§åˆ°ä½™å¼¦ç›¸ä¼¼åº¦æ’åºï¼š

```python
try:
    ranker = RerankRanker()
    ranked_docs = ranker.rank(query, query_embedding, documents, top_k=k)
except Exception as e:
    print(f"[Rerank] ç²¾æ’å¤±è´¥ï¼Œé™çº§ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦: {e}")
    ranker = SimilarityRanker()
    ranked_docs = ranker.rank(query, query_embedding, documents, top_k=k)
```

---

## é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½®
é»˜è®¤ä½¿ç”¨ `BAAI/bge-reranker-v2-m3`ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ `RerankRanker` åˆå§‹åŒ–å‚æ•°æ›´æ¢æ¨¡å‹ï¼š

```python
ranker = RerankRanker(
    model_name="BAAI/bge-reranker-v2-m3",  # æ¨¡å‹åç§°
    use_fp16=True,                          # ä½¿ç”¨ FP16 åŠ é€Ÿ
    batch_size=32,                          # æ‰¹é‡æ¨ç†å¤§å°
    max_length=512                          # æœ€å¤§è¾“å…¥é•¿åº¦
)
```

### å¬å›å‚æ•°
- **recall_k**: ç¬¬ä¸€é˜¶æ®µå¬å›çš„å€™é€‰æ•°é‡
  - æ¨èå€¼ï¼š`k * 3` åˆ° `k * 5`
  - è¿‡å°ï¼šå¯èƒ½é—æ¼ç›¸å…³æ–‡æ¡£
  - è¿‡å¤§ï¼šå¢åŠ æ¨ç†æ—¶é—´

---

## æ³¨æ„äº‹é¡¹

### 1. å†…å­˜å ç”¨
- Rerank æ¨¡å‹çº¦å ç”¨ **1-2GB** æ˜¾å­˜/å†…å­˜
- é¦–æ¬¡åŠ è½½éœ€è¦ä¸‹è½½æ¨¡å‹ï¼ˆçº¦ 600MBï¼‰

### 2. æ¨ç†é€Ÿåº¦
- å•æ¬¡æ¨ç†ï¼š10-50ms
- æ‰¹é‡æ¨ç†ï¼šæ›´å¿«ï¼ˆåˆ©ç”¨æ‰¹å¤„ç†ï¼‰
- å»ºè®®å¬å›å€™é€‰æ•°ä¸è¶…è¿‡ 50

### 3. é€‚ç”¨åœºæ™¯
âœ… **é€‚åˆä½¿ç”¨ Rerank**ï¼š
- å¤æ‚æŸ¥è¯¢ã€é•¿æŸ¥è¯¢
- å¯¹å‡†ç¡®ç‡è¦æ±‚é«˜
- ä¸“ä¸šé¢†åŸŸæ–‡æ¡£æ£€ç´¢

âš ï¸ **ä¸å»ºè®®ä½¿ç”¨ Rerank**ï¼š
- ç®€å•å…³é”®è¯æŸ¥è¯¢
- å®æ—¶æ€§è¦æ±‚æé«˜ï¼ˆ< 50msï¼‰
- èµ„æºå—é™ç¯å¢ƒ

---

## åç»­ä¼˜åŒ–æ–¹å‘

1. **æ¨¡å‹ä¼˜åŒ–**
   - æ”¯æŒæ›´å¤š Rerank æ¨¡å‹ï¼ˆå¦‚ Cohere Rerank APIï¼‰
   - æ¨¡å‹é‡åŒ–ä»¥å‡å°‘å†…å­˜å ç”¨

2. **æ€§èƒ½ä¼˜åŒ–**
   - å¼‚æ­¥æ¨ç†
   - æ¨¡å‹ç¼“å­˜
   - GPU åŠ é€Ÿ

3. **åŠŸèƒ½å¢å¼º**
   - æ”¯æŒè‡ªå®šä¹‰ Rerank æ¨¡å‹
   - æ·»åŠ  Rerank åˆ†æ•°é˜ˆå€¼è¿‡æ»¤
   - æä¾› Rerank æ•ˆæœå¯¹æ¯”å·¥å…·

---

## ç›¸å…³æ–‡ä»¶

- `rag/ranker/rerank_ranker.py` - Rerank æ’åºå™¨å®ç°
- `rag/ranker/__init__.py` - å¯¼å‡º RerankRanker
- `rag_engine.py` - æ£€ç´¢å‡½æ•°å®ç°
- `app.py` - UI é›†æˆ
- `requirements.txt` - ä¾èµ–ç®¡ç†

---

## å‚è€ƒèµ„æ–™

- [FlagEmbedding GitHub](https://github.com/FlagOpen/FlagEmbedding)
- [BGE Reranker æ¨¡å‹](https://huggingface.co/BAAI/bge-reranker-v2-m3)
- [BEIR åŸºå‡†æµ‹è¯•](https://github.com/beir-cellar/beir)

---

**ç‰ˆæœ¬**: v1.0  
**åˆ†æ”¯**: feature/rerank-implementation  
**æ—¥æœŸ**: 2026-01-02
