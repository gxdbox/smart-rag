# 多轮对话功能测试指南

## ✅ 已完成的功能

### 1. 对话历史管理
- ✅ 自动保存用户问题和助手回答
- ✅ 限制历史轮数（最近10轮，20条消息）
- ✅ 对话历史传递给 LLM（最近6轮）

### 2. UI 展示
- ✅ 对话历史展示区（可折叠）
- ✅ 显示对话轮数统计
- ✅ 清空对话按钮
- ✅ 导出对话为 Markdown

### 3. 核心功能
- ✅ `generate_answer()` 支持 `conversation_history` 参数
- ✅ `LLMGenerator` 已实现多轮对话逻辑
- ✅ Prompt 模板包含上下文理解提示

## 🧪 测试场景

### 场景 1：基础追问测试

**第一轮**：
```
用户："什么是 RAG？"
预期：正常回答 RAG 的定义
```

**第二轮**：
```
用户："它有什么优势？"
预期：理解"它"指代 RAG，回答 RAG 的优势
```

**第三轮**：
```
用户："能举个例子吗？"
预期：基于前面的回答，给出 RAG 应用的例子
```

### 场景 2：指代消解测试

**第一轮**：
```
用户："向量检索和 BM25 有什么区别？"
预期：分别介绍两种检索方式
```

**第二轮**：
```
用户："哪个更好？"
预期：理解"哪个"指代向量检索和 BM25，给出对比分析
```

### 场景 3：深入追问测试

**第一轮**：
```
用户："如何优化 RAG 系统？"
预期：给出优化建议
```

**第二轮**：
```
用户："第一点能详细说明吗？"
预期：理解"第一点"指代上一轮回答的第一个优化建议
```

### 场景 4：话题切换测试

**第一轮**：
```
用户："什么是 RAG？"
预期：回答 RAG 定义
```

**第二轮**：
```
用户："知识图谱是什么？"
预期：切换话题，回答知识图谱（不应混淆 RAG）
```

**第三轮**：
```
用户："它们有什么关系？"
预期：理解"它们"指代 RAG 和知识图谱，分析两者关系
```

## 🔍 验证要点

### 1. 对话历史保存
- [ ] 每次问答后，`conversation_history` 增加 2 条记录
- [ ] 历史记录格式正确：`{"role": "user/assistant", "content": "..."}`
- [ ] 超过 20 条消息时，自动删除最旧的记录

### 2. 历史传递
- [ ] `generate_answer()` 接收到 `conversation_history` 参数
- [ ] `LLMGenerator.generate()` 正确处理历史（最近6轮）
- [ ] Prompt 中包含历史对话内容

### 3. UI 功能
- [ ] 对话历史展示区正确显示所有对话
- [ ] 对话轮数统计准确
- [ ] 清空对话功能正常工作
- [ ] 导出对话生成正确的 Markdown 文件

### 4. 上下文理解
- [ ] LLM 能理解代词指代（"它"、"这个"、"那个"）
- [ ] LLM 能理解序号指代（"第一点"、"第二个"）
- [ ] LLM 能理解复数指代（"它们"、"这些"）
- [ ] 话题切换时不会混淆

## 🐛 已知限制

1. **历史长度限制**
   - 只保留最近 10 轮对话（20 条消息）
   - 传递给 LLM 的只有最近 6 轮
   - 超长对话可能丢失早期上下文

2. **检索策略**
   - 每次都会重新检索，未实现智能检索决策
   - 追问类问题可能检索到不相关内容

3. **指代消解**
   - 完全依赖 LLM 的理解能力
   - 没有显式的查询重写机制

## 📝 测试记录模板

```markdown
### 测试时间：2026-01-05 13:40

**测试场景**：基础追问测试

| 轮次 | 用户问题 | 助手回答摘要 | 是否理解上下文 | 备注 |
|------|---------|-------------|--------------|------|
| 1 | 什么是 RAG？ | 正确回答定义 | ✅ | - |
| 2 | 它有什么优势？ | 理解"它"指代 RAG | ✅ | - |
| 3 | 能举个例子吗？ | 给出 RAG 应用例子 | ✅ | - |

**结论**：✅ 通过 / ❌ 失败

**问题**：
- 无

**改进建议**：
- 无
```

## 🎯 下一步优化方向

基于测试结果，可以考虑：

1. **阶段二优化**（如果测试发现问题）
   - 实现查询重写（显式指代消解）
   - 智能检索决策（判断是否需要重新检索）
   - 流式输出（提升体验）

2. **阶段三重构**（长期目标）
   - 完整的 Chat UI
   - 消息编辑和重新生成
   - 对话分支管理

---

**创建时间**：2026-01-05  
**状态**：待测试
